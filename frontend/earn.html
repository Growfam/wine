<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="WINIX - Виконуйте завдання та заробляйте токени">
    <meta name="theme-color" content="#1A1A2E">
    <title>WINIX - Earn</title>

    <!-- ВИПРАВЛЕНО: Оптимізовані критичні стилі для стабільного відображення -->
    <style>
        /* Базові стилі для найшвидшого рендерингу контенту */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #0F0F1A;
            color: #FFFFFF;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #1A1A2E;
        }
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        .loading-indicator .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #E94560;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ВИПРАВЛЕНО: Критичні стилі з кращою підтримкою вкладок і видимості контенту */
        .content-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .content-section.active {
            display: block;
            opacity: 1;
        }
        .tab {
            position: relative;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .tab.active {
            background: linear-gradient(135deg, #4eb5f7, #00C9A7);
            color: white;
            font-weight: bold;
        }

        /* ВИПРАВЛЕНО: Стилі для гарантії видимості кнопки щоденного бонусу */
        #claim-daily {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 10 !important;
            margin-top: 10px !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
            background: linear-gradient(135deg, #4eb5f7, #00C9A7) !important;
            color: white !important;
            font-weight: bold !important;
            border: none !important;
            cursor: pointer !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
        }

        #claim-daily:hover:not(:disabled) {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        #claim-daily:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }

        #claim-daily.disabled {
            background: rgba(200, 200, 200, 0.5) !important;
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Надійна наявність кнопки бонусу */
        #daily-bonus-container {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .daily-bonus {
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            margin-bottom: 15px !important;
        }
    </style>

    <!-- Підключення основних стилів -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/earn/styles.css">

    <!-- Попереднє завантаження критичних ресурсів -->
    <link rel="preload" href="css/earn/components-tasks.css" as="style">
    <link rel="preload" href="js/core.js" as="script">
    <link rel="preload" href="js/tasks/index.js" as="script">

    <!-- Стилі для завдань та анімацій -->
    <link rel="stylesheet" href="css/earn/components-tasks.css">
    <link rel="stylesheet" href="css/earn/leaderboard.css">
    <link rel="stylesheet" href="css/earn/animations.css">
    <link rel="stylesheet" href="css/earn/premium-animations.css">
    <link rel="stylesheet" href="css/earn/premium-theme.css">
    <link rel="stylesheet" href="css/earn/winix-icons.css">

    <!-- Підключення Telegram WebApp API негайно -->
    <script src="js/telegram-web-app.js"></script>
</head>
<body>
<!-- Індикатор завантаження -->
<div id="initial-loading" class="loading-indicator">
    <div class="spinner"></div>
    <p>Завантаження...</p>
</div>

<svg class="winix-filters">
  <defs>
    <!-- Синє світіння -->
    <filter id="blue-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#4EB5F7" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>

    <!-- Бірюзове світіння -->
    <filter id="teal-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#00C9A7" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>

    <!-- Червоне світіння -->
    <filter id="red-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#F44336" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>

    <!-- Золоте світіння -->
    <filter id="gold-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#FFD700" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>
</svg>
    <div class="container">
        <!-- Шапка сторінки -->
        <div class="header">
            <div class="user-profile" id="profile-link">
                <div class="profile-avatar" id="profile-avatar">W</div>
                <div class="user-id-container">
                    <span class="user-id-label" data-lang-key="user_id">ID:</span>
                    <span class="user-id-value" id="user-id"></span>
                </div>
            </div>
            <div class="winix-title">WINIX</div>
            <div class="balance-container">
                <div class="jeton-balance">
                    <div id="user-coins" class="balance-value">0</div>
                    <div class="balance-label" data-lang-key="coins">Жетони</div>
                </div>
                <div class="winix-balance">
                    <div id="user-tokens" class="balance-value">0</div>
                    <div class="balance-label">$WINIX</div>
                </div>
            </div>
        </div>

        <!-- Перемикач категорій завдань -->
        <div class="tabs">
            <div class="tab active" data-tab="social" data-lang-key="earn.social_networks">Соціальні</div>
            <div class="tab" data-tab="limited" data-lang-key="earn.limited_tasks">Лімітовані</div>
            <div class="tab" data-tab="partners" data-lang-key="earn.partners_tasks">Партнерські</div>
        </div>

        <!-- Контейнери для різних типів завдань -->
        <!-- Соціальні завдання -->
        <div class="content-section active" id="social-content">
            <!-- Щоденний бонус -->
            <div class="category-card" id="daily-bonus-container">
                <div class="category-title" data-lang-key="earn.daily_bonus">Щоденний бонус</div>
                <div class="daily-bonus">
                    <div class="daily-bonus-bar">
                        <div class="daily-progress" id="daily-progress-container">
                            <!-- Дні генеруються динамічно через JS -->
                        </div>
                    </div>
                    <button class="claim-button" id="claim-daily" data-lang-key="earn.get">Отримати бонус</button>
                </div>
            </div>

            <!-- Соціальні завдання -->
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.social_networks">Соціальні мережі</div>
                <div class="task-container" id="social-tasks-container" aria-live="polite">
                    <!-- Соціальні завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>

            <!-- Реферальні завдання -->
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.referral_tasks">Реферальні завдання</div>
                <div class="task-container" id="referral-tasks-container" aria-live="polite">
                    <!-- Реферальні завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>

            <!-- Лідерська дошка -->
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.leaderboard">Лідерська дошка</div>
                <div class="leaderboard-title" data-lang-key="earn.leaderboard.title">Топ-10 користувачів з найбільшою кількістю запрошених друзів</div>
                <div class="leaderboard" id="leaderboard-container" aria-live="polite">
                    <!-- Лідерська дошка генерується динамічно через JS -->
                    <div class="leaderboard-loader">Завантаження лідерської дошки...</div>
                </div>
            </div>
        </div>

        <!-- Лімітовані завдання -->
        <div class="content-section" id="limited-content">
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.limited_tasks">Обмежені за часом завдання</div>
                <div class="task-container" id="limited-tasks-container" aria-live="polite">
                    <!-- Лімітовані завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>
        </div>

        <!-- Партнерські завдання -->
        <div class="content-section" id="partners-content">
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.partners_tasks">Партнерські завдання</div>
                <div class="task-container" id="partners-tasks-container" aria-live="polite">
                    <!-- Партнерські завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>
        </div>

        <!-- Нижня навігаційна панель -->
        <div class="nav-bar">
            <div class="nav-item" data-section="home">
                <div class="icon-wrapper">
                    <img src="assets/home-icon.png" alt="Home" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Home'">
                </div>
                <span data-lang-key="home">Home</span>
            </div>
            <div class="nav-item active" data-section="earn">
                <div class="icon-wrapper">
                    <img src="assets/earn-icon.png" alt="Earn" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Earn'">
                </div>
                <span data-lang-key="earn">Earn</span>
            </div>
            <div class="nav-item" data-section="referrals">
                <div class="icon-wrapper">
                    <img src="assets/referrals-icon.png" alt="Referrals" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Referrals'">
                </div>
                <span data-lang-key="referrals">Referrals</span>
            </div>
            <div class="nav-item" data-section="wallet">
                <div class="icon-wrapper">
                    <img src="assets/wallet-icon.png" alt="Wallet" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Wallet'">
                </div>
                <span data-lang-key="wallet">Wallet</span>
            </div>
            <div class="nav-item" data-section="general">
                <div class="icon-wrapper">
                    <img src="assets/general-icon.png" alt="General" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=General'">
                </div>
                <span data-lang-key="general">General</span>
            </div>
        </div>
    </div>

    <!-- Повідомлення для копіювання -->
    <div class="toast-message" id="toast-message" aria-live="assertive" role="alert">Реферальне посилання скопійовано в буфер обміну!</div>

    <!-- ВИПРАВЛЕНО: Оптимізована послідовність завантаження скриптів -->
    <!-- Першочергові скрипти -->
    <script src="js/core.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>


    <!-- Підключення системи завдань -->
    <script type="module">
    // Перевірка наявності залежностей
    if (!window.WinixAPI) {
        console.error('❌ WinixAPI не знайдено. Перевірте, чи завантажено api.js');
    }

    if (!window.WinixAuth) {
        console.error('❌ WinixAuth не знайдено. Перевірте, чи завантажено auth.js');
    }

    if (!window.dependencyContainer) {
        console.warn('⚠️ dependencyContainer не знайдено. Це може призвести до проблем із залежностями.');
        // Створюємо просту заглушку для DI-контейнера
        window.dependencyContainer = {
            register: () => {},
            resolve: () => null,
            has: () => false
        };
    }

    // Визначення getUserId, якщо він відсутній
    if (typeof window.getUserId !== 'function') {
        window.getUserId = function() {
            try {
                return localStorage.getItem('telegram_user_id') ||
                      (new URLSearchParams(window.location.search).get('id'));
            } catch (e) {
                console.error('❌ Помилка отримання ID користувача:', e);
                return null;
            }
        };
    }

    // Імпорт системи завдань з відносного шляху
    let taskSystem;
    let importSuccess = false;
    try {
        taskSystem = await import('./js/tasks/index.js').then(module => module.default);
        console.log('✅ Систему завдань успішно імпортовано');
        importSuccess = true;
    } catch (error) {
        console.error('❌ Не вдалося імпортувати систему завдань:', error);

        // Показуємо повідомлення про помилку
        const toast = document.getElementById('toast-message');
        if (toast) {
            toast.textContent = 'Помилка завантаження системи. Спробуйте оновити сторінку.';
            toast.className = 'toast-message toast-error show';

            setTimeout(() => {
                toast.className = 'toast-message';
            }, 3000);
        }

        // Ховаємо індикатор завантаження
        const loadingIndicator = document.getElementById('initial-loading');
        if (loadingIndicator) {
            loadingIndicator.style.opacity = '0';
            setTimeout(() => {
                loadingIndicator.style.display = 'none';
            }, 300);
        }
    }

    // Деякі загальні змінні для роботи з UI
    let dailyBonusInitialized = false;

    // Після завантаження DOM
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('📱 WINIX - Ініціалізація сторінки завдань');

        // Перевіряємо, чи вдалося імпортувати систему завдань
        if (!importSuccess) {
            console.warn('⚠️ Пропускаємо ініціалізацію через помилку імпорту');
            hideLoadingIndicator();
            return;
        }

        try {
            // Ініціалізуємо систему завдань
            const initialized = await taskSystem.initialize({
                forceRefresh: false,
                ui: {
                    animations: {
                        enabled: true,
                        performanceMode: window.innerWidth < 768 // Режим продуктивності на мобільних
                    }
                }
            });

            if (initialized) {
                console.log('✅ Система завдань успішно ініціалізована');

                // Ініціалізуємо компоненти щоденного бонусу
                initializeDailyBonus();

                // Ініціалізуємо вкладки
                initializeTabs();

                // Ховаємо індикатор завантаження
                hideLoadingIndicator();
            } else {
                console.error('❌ Помилка ініціалізації системи завдань');
                showErrorMessage('Не вдалося завантажити систему завдань. Спробуйте оновити сторінку.');
            }
        } catch (error) {
            console.error('❌ Критична помилка:', error);
            showErrorMessage('Виникла помилка при завантаженні даних');
        }
    });

        /**
         * Ініціалізація системи вкладок
         */
        function initializeTabs() {
            const tabs = document.querySelectorAll('.tab');
            const contentSections = document.querySelectorAll('.content-section');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabType = tab.getAttribute('data-tab');

                    // Змінюємо активну вкладку
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Змінюємо видимий контент
                    contentSections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === `${tabType}-content`) {
                            section.classList.add('active');
                        }
                    });

                    // Повідомляємо систему завдань про зміну вкладки
                    if (taskSystem && taskSystem.setActiveTab) {
                        taskSystem.setActiveTab(tabType);
                    }
                });
            });
        }

        /**
         * Ініціалізація компонента щоденного бонусу
         */
        function initializeDailyBonus() {
            if (dailyBonusInitialized) return;

            // Отримуємо елементи
            const claimButton = document.getElementById('claim-daily');
            const progressContainer = document.getElementById('daily-progress-container');

            if (!claimButton || !progressContainer) {
                console.warn('⚠️ Елементи щоденного бонусу не знайдено');
                return;
            }

            // Створюємо календар бонусів на 7 днів
            createDailyBonusCalendar(progressContainer);

            // Завантажуємо стан щоденного бонусу
            loadDailyBonusStatus();

            // Додаємо обробник кліку на кнопку отримання бонусу
            claimButton.addEventListener('click', claimDailyBonus);

            // Позначаємо, що ініціалізовано
            dailyBonusInitialized = true;
        }

        /**
         * Створення календаря щоденного бонусу
         * @param {HTMLElement} container - Контейнер для календаря
         */
        function createDailyBonusCalendar(container) {
            // Очищаємо контейнер
            container.innerHTML = '';

            // Створюємо 7 днів
            for (let i = 1; i <= 7; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'daily-day';
                dayElement.dataset.day = i;

                const dayCircle = document.createElement('div');
                dayCircle.className = 'day-circle';
                dayCircle.textContent = i;

                // Додаємо мітку токена на кожен 7-й день
                if (i % 7 === 0) {
                    const tokenBadge = document.createElement('div');
                    tokenBadge.className = 'token-badge-small';
                    tokenBadge.textContent = '⭐';
                    dayCircle.appendChild(tokenBadge);
                }

                const dayReward = document.createElement('div');
                dayReward.className = 'day-reward';

                // Встановлюємо винагороду (модель нагород: день 7 = 50 жетонів, інші дні = 10)
                const rewardAmount = i % 7 === 0 ? 50 : 10;
                dayReward.textContent = `${rewardAmount} ₴`;

                dayElement.appendChild(dayCircle);
                dayElement.appendChild(dayReward);
                container.appendChild(dayElement);
            }
        }

        /**
         * Завантаження статусу щоденного бонусу
         */
        async function loadDailyBonusStatus() {
            try {
                // Перевіряємо наявність API для щоденного бонусу
                if (!taskSystem.dailyBonus || !taskSystem.dailyBonus.getStatus) {
                    console.warn('⚠️ API щоденного бонусу недоступне');
                    return;
                }

                // Завантажуємо статус
                const response = await taskSystem.dailyBonus.getStatus();

                if (response.success) {
                    updateDailyBonusUI(response.data);
                } else {
                    console.warn('⚠️ Помилка отримання статусу щоденного бонусу:', response.message);
                }
            } catch (error) {
                console.error('❌ Помилка завантаження щоденного бонусу:', error);
            }
        }

        /**
         * Отримання щоденного бонусу
         */
        async function claimDailyBonus() {
            const claimButton = document.getElementById('claim-daily');

            if (!claimButton || claimButton.disabled) return;

            try {
                // Показуємо стан завантаження
                claimButton.disabled = true;
                claimButton.classList.add('processing');
                claimButton.textContent = 'Отримання...';

                // Викликаємо API отримання бонусу
                const result = await taskSystem.claimDailyBonus();

                if (result.success) {
                    // Оновлюємо UI
                    updateDailyBonusUI({
                        ...result.data,
                        claimed_today: true
                    });

                    // Показуємо повідомлення про успіх
                    showSuccessMessage(`Щоденний бонус отримано: +${result.data.amount} жетонів!`);

                    // Оновлюємо баланс (анімовано)
                    updateBalanceUI(result.data.amount);
                } else {
                    // Показуємо повідомлення про помилку
                    showErrorMessage(result.message || 'Не вдалося отримати щоденний бонус');
                }
            } catch (error) {
                console.error('❌ Помилка отримання щоденного бонусу:', error);
                showErrorMessage('Помилка отримання щоденного бонусу');
            } finally {
                // Відновлюємо кнопку
                const claimButton = document.getElementById('claim-daily');
                if (claimButton) {
                    claimButton.disabled = false;
                    claimButton.classList.remove('processing');
                    claimButton.textContent = 'Отримати бонус';
                }
            }
        }

        /**
         * Оновлення UI щоденного бонусу
         * @param {Object} data - Дані щоденного бонусу
         */
        function updateDailyBonusUI(data) {
            if (!data) return;

            const { current_day = 1, claimed_today = false, streak = 0 } = data;
            const claimButton = document.getElementById('claim-daily');
            const progressContainer = document.getElementById('daily-progress-container');

            if (!claimButton || !progressContainer) return;

            // Оновлюємо дні
            const dayElements = progressContainer.querySelectorAll('.daily-day');
            dayElements.forEach(dayElement => {
                const day = parseInt(dayElement.dataset.day);
                const dayCircle = dayElement.querySelector('.day-circle');

                // Видаляємо всі класи стану
                dayCircle.classList.remove('active', 'completed', 'current');

                if (day < current_day) {
                    // Попередні дні (отримані)
                    dayCircle.classList.add('completed');
                } else if (day === current_day) {
                    // Поточний день
                    dayCircle.classList.add('current');

                    // Якщо вже отримано сьогодні
                    if (claimed_today) {
                        dayCircle.classList.add('completed');
                    } else {
                        dayCircle.classList.add('active');
                    }
                }
            });

            // Оновлюємо кнопку
            if (claimed_today) {
                claimButton.disabled = true;
                claimButton.classList.add('disabled');
                claimButton.textContent = 'Вже отримано';
            } else {
                claimButton.disabled = false;
                claimButton.classList.remove('disabled');
                claimButton.textContent = 'Отримати бонус';
            }
        }

        /**
         * Оновлення відображення балансу
         * @param {number} amount - Сума для додавання
         */
        function updateBalanceUI(amount) {
            const userCoins = document.getElementById('user-coins');
            if (!userCoins) return;

            // Отримуємо поточне значення
            const currentValue = parseInt(userCoins.textContent) || 0;

            // Встановлюємо нове значення
            userCoins.textContent = currentValue + amount;

            // Додаємо клас для анімації
            userCoins.classList.add('balance-increased');

            // Видаляємо клас через 1.5 секунди
            setTimeout(() => {
                userCoins.classList.remove('balance-increased');
            }, 1500);
        }

        /**
         * Показати повідомлення про успіх
         * @param {string} message - Текст повідомлення
         */
        function showSuccessMessage(message) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;

            toast.textContent = message;
            toast.className = 'toast-message toast-success show';

            setTimeout(() => {
                toast.className = 'toast-message';
            }, 3000);
        }

        /**
         * Показати повідомлення про помилку
         * @param {string} message - Текст помилки
         */
        function showErrorMessage(message) {
            const toast = document.getElementById('toast-message');
            if (!toast) return;

            toast.textContent = message;
            toast.className = 'toast-message toast-error show';

            setTimeout(() => {
                toast.className = 'toast-message';
            }, 3000);
        }

        /**
         * Сховати індикатор завантаження
         */
        function hideLoadingIndicator() {
            const loadingIndicator = document.getElementById('initial-loading');
            if (loadingIndicator) {
                // Плавно приховуємо
                loadingIndicator.style.opacity = '0';

                // Після закінчення анімації видаляємо з DOM
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 300);
            }
        }
    </script>
</body>
</html>