<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta name="description" content="WINIX - Виконуйте завдання та заробляйте токени">
    <meta name="theme-color" content="#1A1A2E">
    <title>WINIX - Заробляй</title>

    <!-- ВИПРАВЛЕНО: Оптимізовані критичні стилі для стабільного відображення -->
    <style>
        /* Базові стилі для найшвидшого рендерингу контенту */
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #0F0F1A;
            color: #FFFFFF;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            position: relative;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #1A1A2E;
        }
        .loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        .loading-indicator .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #E94560;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ВИПРАВЛЕНО: Критичні стилі з кращою підтримкою вкладок і видимості контенту */
        .content-section {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .content-section.active {
            display: block;
            opacity: 1;
        }
        .tab {
            position: relative;
            cursor: pointer;
            user-select: none;
            touch-action: manipulation;
        }
        .tab.active {
            background: linear-gradient(135deg, #4eb5f7, #00C9A7);
            color: white;
            font-weight: bold;
        }

        /* ВИПРАВЛЕНО: Стилі для гарантії видимості кнопки щоденного бонусу */
        #claim-daily {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
            z-index: 10 !important;
            margin-top: 10px !important;
            padding: 10px 20px !important;
            border-radius: 8px !important;
            background: linear-gradient(135deg, #4eb5f7, #00C9A7) !important;
            color: white !important;
            font-weight: bold !important;
            border: none !important;
            cursor: pointer !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease !important;
        }

        #claim-daily:hover:not(:disabled) {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
        }

        #claim-daily:disabled {
            opacity: 0.7 !important;
            cursor: not-allowed !important;
        }

        #claim-daily.disabled {
            background: rgba(200, 200, 200, 0.5) !important;
            color: rgba(255, 255, 255, 0.8) !important;
        }

        /* Надійна наявність кнопки бонусу */
        #daily-bonus-container {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .daily-bonus {
            position: relative !important;
            display: flex !important;
            flex-direction: column !important;
            width: 100% !important;
            margin-bottom: 15px !important;
        }
    </style>

    <!-- Підключення основних стилів -->
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/earn/styles.css">

    <!-- Попереднє завантаження критичних ресурсів -->
    <link rel="preload" href="css/earn/components-tasks.css" as="style">
    <link rel="preload" href="js/core.js" as="script">
    <link rel="preload" href="js/tasks/core/task-manager.js" as="script">
    <link rel="preload" href="js/tasks/components/daily-bonus.js" as="script">

    <!-- Відкладене завантаження некритичних стилів -->
    <link rel="stylesheet" href="css/earn/components-tasks.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/earn/leaderboard.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/earn/premium-animations.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="css/earn/winix-icons.css" media="print" onload="this.media='all'">

    <!-- Запасні варіанти для браузерів без підтримки onload для стилів -->
    <noscript>
        <link rel="stylesheet" href="css/earn/components-tasks.css">
        <link rel="stylesheet" href="css/earn/leaderboard.css">
        <link rel="stylesheet" href="css/earn/premium-animations.css">
        <link rel="stylesheet" href="css/earn/winix-icons.css">
    </noscript>

    <!-- Підключення Telegram WebApp API негайно -->
    <script src="js/telegram-web-app.js"></script>
</head>
<body>
<!-- Індикатор завантаження -->
<div id="initial-loading" class="loading-indicator">
    <div class="spinner"></div>
    <p>Завантаження...</p>
</div>

<svg class="winix-filters">
  <defs>
    <!-- Синє світіння -->
    <filter id="blue-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#4EB5F7" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>

    <!-- Бірюзове світіння -->
    <filter id="teal-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#00C9A7" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>

    <!-- Червоне світіння -->
    <filter id="red-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#F44336" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>

    <!-- Золоте світіння -->
    <filter id="gold-glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
      <feFlood flood-color="#FFD700" flood-opacity="0.5" result="color" />
      <feComposite in="color" in2="blur" operator="in" result="glow" />
      <feMerge>
        <feMergeNode in="glow" />
        <feMergeNode in="SourceGraphic" />
      </feMerge>
    </filter>
  </defs>
</svg>
    <div class="container">
        <!-- Шапка сторінки -->
        <div class="header">
            <div class="user-profile" id="profile-link">
                <div class="profile-avatar" id="profile-avatar">W</div>
                <div class="user-id-container">
                    <span class="user-id-label" data-lang-key="user_id">ID:</span>
                    <span class="user-id-value" id="user-id"></span>
                </div>
            </div>
            <div class="winix-title">WINIX</div>
            <div class="balance-container">
                <div class="jeton-balance">
                    <div id="user-coins" class="balance-value">0</div>
                    <div class="balance-label" data-lang-key="coins">Жетони</div>
                </div>
                <div class="winix-balance">
                    <div id="user-tokens" class="balance-value">0</div>
                    <div class="balance-label">$WINIX</div>
                </div>
            </div>
        </div>

        <!-- Перемикач категорій завдань -->
        <div class="tabs">
            <div class="tab active" data-tab="social" data-lang-key="earn.social_networks">Соціальні</div>
            <div class="tab" data-tab="limited" data-lang-key="earn.limited_tasks">Лімітовані</div>
            <div class="tab" data-tab="partners" data-lang-key="earn.partners_tasks">Партнерські</div>
        </div>

        <!-- Контейнери для різних типів завдань -->
        <!-- Соціальні завдання -->
        <div class="content-section active" id="social-content">
            <!-- Щоденний бонус -->
            <div class="category-card" id="daily-bonus-container">
                <div class="category-title" data-lang-key="earn.daily_bonus">Щоденний бонус</div>
                <div class="daily-bonus">
                    <div class="daily-bonus-bar">
                        <div class="daily-progress" id="daily-progress-container">
                            <!-- Дні генеруються динамічно через JS -->
                        </div>
                    </div>
                    <button class="claim-button" id="claim-daily" data-lang-key="earn.get">Отримати бонус</button>
                </div>
            </div>

            <!-- Соціальні завдання -->
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.social_networks">Соціальні мережі</div>
                <div class="task-container" id="social-tasks-container" aria-live="polite">
                    <!-- Соціальні завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>

            <!-- Реферальні завдання -->
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.referral_tasks">Реферальні завдання</div>
                <div class="task-container" id="referral-tasks-container" aria-live="polite">
                    <!-- Реферальні завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>

            <!-- Лідерська дошка -->
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.leaderboard">Лідерська дошка</div>
                <div class="leaderboard-title" data-lang-key="earn.leaderboard.title">Топ-10 користувачів з найбільшою кількістю запрошених друзів</div>
                <div class="leaderboard" id="leaderboard-container" aria-live="polite">
                    <!-- Лідерська дошка генерується динамічно через JS -->
                    <div class="leaderboard-loader">Завантаження лідерської дошки...</div>
                </div>
            </div>
        </div>

        <!-- Лімітовані завдання -->
        <div class="content-section" id="limited-content">
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.limited_tasks">Обмежені за часом завдання</div>
                <div class="task-container" id="limited-tasks-container" aria-live="polite">
                    <!-- Лімітовані завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>
        </div>

        <!-- Партнерські завдання -->
        <div class="content-section" id="partners-content">
            <div class="category-card">
                <div class="category-title" data-lang-key="earn.partners_tasks">Партнерські завдання</div>
                <div class="task-container" id="partners-tasks-container" aria-live="polite">
                    <!-- Партнерські завдання генеруються динамічно через JS -->
                    <div class="task-loader">Завантаження завдань...</div>
                </div>
            </div>
        </div>

        <!-- Нижня навігаційна панель -->
        <div class="nav-bar">
            <div class="nav-item" data-section="home">
                <div class="icon-wrapper">
                    <img src="assets/home-icon.png" alt="Home" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Home'">
                </div>
                <span data-lang-key="home">Home</span>
            </div>
            <div class="nav-item active" data-section="earn">
                <div class="icon-wrapper">
                    <img src="assets/earn-icon.png" alt="Earn" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Earn'">
                </div>
                <span data-lang-key="earn">Earn</span>
            </div>
            <div class="nav-item" data-section="referrals">
                <div class="icon-wrapper">
                    <img src="assets/referrals-icon.png" alt="Referrals" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Referrals'">
                </div>
                <span data-lang-key="referrals">Referrals</span>
            </div>
            <div class="nav-item" data-section="wallet">
                <div class="icon-wrapper">
                    <img src="assets/wallet-icon.png" alt="Wallet" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=Wallet'">
                </div>
                <span data-lang-key="wallet">Wallet</span>
            </div>
            <div class="nav-item" data-section="general">
                <div class="icon-wrapper">
                    <img src="assets/general-icon.png" alt="General" loading="lazy" onerror="this.src='https://via.placeholder.com/35?text=General'">
                </div>
                <span data-lang-key="general">General</span>
            </div>
        </div>
    </div>

    <!-- Повідомлення для копіювання -->
    <div class="toast-message" id="toast-message" aria-live="assertive" role="alert">Реферальне посилання скопійовано в буфер обміну!</div>

    <!-- ВИПРАВЛЕНО: Оптимізована послідовність завантаження скриптів -->
    <!-- Першочергові скрипти (блокуючі) -->
    <script src="js/telegram-web-app.js"></script>

    <!-- ВИПРАВЛЕНО: Пріоритетне завантаження ключових модулів -->
    <script src="js/core.js"></script>
    <script src="js/api.js"></script>
    <script src="js/auth.js"></script>

    <!-- Основні компоненти системи завдань -->
    <script src="js/tasks/utils/api-connectivity.js"></script>
    <script src="js/tasks/utils/formatters.js"></script>
    <script src="js/tasks/utils/storage.js"></script>

    <!-- ВИПРАВЛЕНО: Першочергове завантаження TaskManager -->
    <script src="js/tasks/core/task-manager.js"></script>

    <!-- ВИПРАВЛЕНО: Вставлення пріоритетних модулів до завантаження інших -->
    <script src="js/tasks/components/daily-bonus.js"></script>

    <!-- Допоміжні утиліти (з defer для асинхронного завантаження) -->
    <script src="js/tasks/utils/time-utils.js" defer></script>
    <script src="js/tasks/utils/validators.js" defer></script>

    <!-- UI компоненти (з defer) -->
    <script src="js/tasks/ui/animations.js" defer></script>
    <script src="js/tasks/ui/countdown.js" defer></script>
    <script src="js/tasks/ui/notifications.js" defer></script>
    <script src="js/tasks/ui/progress-bar.js" defer></script>

    <!-- Основна логіка завдань (з defer) -->
    <script src="js/tasks/core/progress.js" defer></script>
    <script src="js/tasks/core/rewards.js" defer></script>
    <script src="js/tasks/core/verification.js" defer></script>
    <script src="js/tasks/core/integration.js" defer></script>

    <!-- Компоненти завдань (з defer) -->
    <script src="js/tasks/components/social-task.js" defer></script>
    <script src="js/tasks/components/limited-task.js" defer></script>
    <script src="js/tasks/components/partner-task.js" defer></script>
    <script src="js/tasks/components/leaderboard.js" defer></script>

    <script>
        // ВИПРАВЛЕНО: Удосконалена логіка ініціалізації
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded');

            // Запам'ятовуємо, чи завантажені ключові компоненти
            let componentsLoaded = {
                core: false,
                taskManager: false,
                dailyBonus: false
            };

            // Функція для перевірки готовності всіх ключових компонентів
            function checkComponentsReady() {
                return componentsLoaded.core && componentsLoaded.taskManager && componentsLoaded.dailyBonus;
            }

            // Функція для оновлення стану і запуску ініціалізації, якщо все готово
            function updateComponentState(component) {
                componentsLoaded[component] = true;
                if (checkComponentsReady()) {
                    startInitialization();
                }
            }

            // Діагностична перевірка системи
            window.diagnoseSystemState = function() {
                console.group('Діагностика системи');
                console.log('DOM готовий:', document.readyState);
                console.log('API доступний:', !!window.API);
                console.log('API_PATHS доступний:', !!window.API_PATHS);
                console.log('TaskManager доступний:', !!window.TaskManager);
                console.log('SocialTask доступний:', !!window.SocialTask);
                console.log('TaskIntegration доступний:', !!window.TaskIntegration);
                console.log('Core доступний:', !!window.WinixCore);
                console.log('DailyBonus доступний:', !!window.DailyBonus);
                console.groupEnd();
            };

            // Ініціалізація системи після завантаження всіх компонентів
            function startInitialization() {
                console.log('Всі компоненти завантажені, починаємо ініціалізацію...');

                // Перевіряємо наявність і ініціалізуємо компоненти
                if (window.WinixCore) {
                    window.WinixCore.init();
                }

                if (window.TaskManager) {
                    window.TaskManager.init();
                }

                if (window.DailyBonus) {
                    window.DailyBonus.init();

                    // Додатково гарантуємо видимість кнопки бонусу
                    setTimeout(function() {
                        if (window.DailyBonus.ensureButtonVisibility) {
                            window.DailyBonus.ensureButtonVisibility();
                        }
                    }, 1000);
                }

                // Діагностика для перевірки стану
                window.diagnoseSystemState();

                // Приховуємо індикатор завантаження
                hideLoadingIndicator();

                console.log('Ініціалізацію завершено');
            }

            // Функція для приховування індикатора завантаження
            function hideLoadingIndicator() {
                const loadingIndicator = document.getElementById('initial-loading');
                if (loadingIndicator) {
                    loadingIndicator.style.opacity = '0';
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 300);
                }
            }

            // Ініціалізуємо Telegram WebApp, якщо він доступний
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }

            // Перевіряємо завантаження ключових компонентів
            if (window.WinixCore) {
                updateComponentState('core');
            } else {
                // Встановлюємо обробник для відстеження завантаження Core
                window.addEventListener('CoreLoaded', function() {
                    updateComponentState('core');
                });

                // Запасний варіант перевірки
                setTimeout(function checkCore() {
                    if (window.WinixCore) {
                        updateComponentState('core');
                    } else {
                        setTimeout(checkCore, 200);
                    }
                }, 200);
            }

            if (window.TaskManager) {
                updateComponentState('taskManager');
            } else {
                // Встановлюємо обробник для відстеження завантаження TaskManager
                window.addEventListener('TaskManagerLoaded', function() {
                    updateComponentState('taskManager');
                });

                // Запасний варіант перевірки
                setTimeout(function checkTaskManager() {
                    if (window.TaskManager) {
                        updateComponentState('taskManager');
                    } else {
                        setTimeout(checkTaskManager, 200);
                    }
                }, 200);
            }

            if (window.DailyBonus) {
                updateComponentState('dailyBonus');
            } else {
                // Встановлюємо обробник для відстеження завантаження DailyBonus
                window.addEventListener('DailyBonusLoaded', function() {
                    updateComponentState('dailyBonus');
                });

                // Запасний варіант перевірки
                setTimeout(function checkDailyBonus() {
                    if (window.DailyBonus) {
                        updateComponentState('dailyBonus');
                    } else {
                        setTimeout(checkDailyBonus, 200);
                    }
                }, 200);
            }

            // Встановлюємо таймер для гарантованого приховування індикатора завантаження
            setTimeout(hideLoadingIndicator, 3000);

            // Встановлюємо таймер для примусової ініціалізації, якщо щось пішло не так
            setTimeout(function() {
                if (!checkComponentsReady()) {
                    console.warn('Не всі компоненти завантажилися вчасно, виконуємо примусову ініціалізацію');

                    // Оновлюємо стан всіх компонентів
                    componentsLoaded.core = !!window.WinixCore;
                    componentsLoaded.taskManager = !!window.TaskManager;
                    componentsLoaded.dailyBonus = !!window.DailyBonus;

                    // Запускаємо ініціалізацію з доступними компонентами
                    startInitialization();
                }
            }, 5000);
        });

        // Обробка події завантаження сторінки
        window.addEventListener('load', function() {
            console.log('All resources loaded');

            // Перевіряємо наявність бонусної кнопки і встановлюємо її видимість
            const bonusButton = document.getElementById('claim-daily');
            if (bonusButton) {
                bonusButton.style.display = 'block';
            }

            // Явно запускаємо гарантію видимості кнопки бонусу
            if (window.DailyBonus && window.DailyBonus.ensureButtonVisibility) {
                window.DailyBonus.ensureButtonVisibility();
            }

            // Оновлення контентних зон, якщо необхідно
            if (window.TaskManager && window.TaskManager.refreshAllTasks) {
                window.TaskManager.refreshAllTasks();
            }
        });

        // ВИПРАВЛЕНО: Обробка помилок завантаження скриптів
        window.addEventListener('error', function(e) {
            if (e.target && e.target.tagName === 'SCRIPT') {
                console.error('Failed to load script:', e.target.src);

                // Отримуємо базову назву скрипта для визначення ключових компонентів
                let scriptPath = e.target.src;
                let scriptName = scriptPath.split('/').pop();

                // Перевіряємо, чи ключовий це компонент
                if (scriptName === 'task-manager.js' || scriptName === 'core.js' || scriptName === 'daily-bonus.js') {
                    console.warn('Помилка завантаження ключового компонента:', scriptName);
                }

                // Спробуємо перезавантажити скрипт
                const failedScript = e.target;
                const scriptSrc = failedScript.src;

                if (scriptSrc && !scriptSrc.includes('already-retried')) {
                    console.log('Attempting to reload script:', scriptSrc);

                    // Створюємо новий елемент script
                    const newScript = document.createElement('script');
                    newScript.src = scriptSrc + '?already-retried=true';
                    newScript.defer = failedScript.defer;
                    newScript.async = failedScript.async;

                    // Замінюємо старий елемент
                    failedScript.parentNode.replaceChild(newScript, failedScript);
                }
            }
        }, true);
    </script>
</body>
</html>