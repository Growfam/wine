<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WINIX - Реферальна програма</title>
    <link rel="stylesheet" href="css/referrals/styles.css">
    <link rel="stylesheet" href="css/referrals/animations.css">
    <link rel="stylesheet" href="css/referrals/winix-icons.css">
    <link rel="stylesheet" href="css/referrals/referrals.css">
    <link rel="stylesheet" href="css/referrals/referrals-animations.css">
    <link rel="stylesheet" href="css/referrals/referrals-tabs.css">
    <link rel="stylesheet" href="css/referrals/referral-levels.css">
    <link rel="stylesheet" href="css/referrals/referral-structure.css">
    <link rel="stylesheet" href="css/referrals/percentage-rewards.css">
    <link rel="stylesheet" href="css/referrals/referral-activity.css">
    <link rel="stylesheet" href="css/referrals/badges-tasks.css">
    <link rel="stylesheet" href="css/referrals/referral-tabs-fix.css">
    <link rel="preload" href="assets/badges-icons.svg" as="image" type="image/svg+xml">
</head>
<body>
    <!-- SVG фільтри для іконок -->
    <svg class="winix-filters">
      <defs>
        <!-- Синє світіння -->
        <filter id="blue-glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
          <feFlood flood-color="#4EB5F7" flood-opacity="0.5" result="color" />
          <feComposite in="color" in2="blur" operator="in" result="glow" />
          <feMerge>
            <feMergeNode in="glow" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>

        <!-- Бірюзове світіння -->
        <filter id="teal-glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
          <feFlood flood-color="#00C9A7" flood-opacity="0.5" result="color" />
          <feComposite in="color" in2="blur" operator="in" result="glow" />
          <feMerge>
            <feMergeNode in="glow" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>

        <!-- Золоте світіння -->
        <filter id="gold-glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur in="SourceGraphic" stdDeviation="1.5" result="blur" />
          <feFlood flood-color="#FFD700" flood-opacity="0.5" result="color" />
          <feComposite in="color" in2="blur" operator="in" result="glow" />
          <feMerge>
            <feMergeNode in="glow" />
            <feMergeNode in="SourceGraphic" />
          </feMerge>
        </filter>
      </defs>
    </svg>

    <div class="container">
        <!-- Шапка сторінки -->
        <header class="header" style="color: white;">
            <div class="user-profile">
                <div class="profile-avatar">W</div>
                <div class="user-id-container">
                    <div class="user-id-label">Ваш ID</div>
                    <div class="user-id-value" id="header-user-id">Loading...</div>
                </div>
            </div>
            <div class="winix-title">WINIX</div>
            <div class="balance-container">
                <div class="jeton-balance">
                    <div class="balance-value" id="user-coins">750</div>
                    <div class="balance-label">Ticket</div>
                </div>
                <div class="winix-balance">
                    <div class="balance-value" id="user-tokens">1250</div>
                    <div class="balance-label">Winix</div>
                </div>
            </div>
        </header>

        <!-- Основний контент -->
        <section class="category-card referral-section">
            <h2 class="category-title">Реферальна програма</h2>

            <!-- Головні вкладки реферальної системи -->
            <div class="main-tabs">
                <div class="tab-button active" data-tab="referrals">Реферали</div>
                <div class="tab-button" data-tab="badges">Бейджі</div>
                <div class="tab-button" data-tab="statistics">Статистика</div>
            </div>

            <!-- Контент вкладок -->
            <div class="tab-content">
                <!-- ВКЛАДКА 1: РЕФЕРАЛИ -->
                <div class="main-tab-pane active" id="referrals-tab">
                    <!-- Реферальне посилання -->
                    <div class="rewards-container">
                        <h3 class="referral-subtitle">Ваше реферальне посилання</h3>
                        <div class="rewards-box" style="flex-direction: column;">
                            <div class="reward-item">
                                <div style="width: 100%; text-align: center; display: flex; flex-direction: column; align-items: center;">
                                    <div class="link-display" style="width: 100%; margin-bottom: 15px;">Завантаження...</div>
                                    <button class="copy-button" style="margin-top: 10px; width: 100%; display: flex; justify-content: center;">
                                        <span class="copy-icon"></span>
                                        <span class="button-text">Копіювати</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <p class="referral-info">
                            Діліться своїм посиланням та заробляйте з кожного реферала!
                        </p>
                    </div>

                    <!-- Винагороди -->
                    <div class="rewards-container">
                        <h3 class="referral-subtitle">Ваші винагороди</h3>
                        <div class="rewards-box">
                            <div class="reward-item">
                                <div class="reward-icon direct-bonus-icon"></div>
                                <div class="reward-details">
                                    <div class="reward-title">Бонус за реферала</div>
                                    <div class="reward-description"><span class="bonus-amount">50</span> winix за кожного нового реферала</div>
                                </div>
                            </div>
                            <div class="reward-item">
                                <div class="reward-icon percentage-icon"></div>
                                <div class="reward-details">
                                    <div class="reward-title">Відсотки від прибутку</div>
                                    <div class="reward-description">10% від рефералів 1-го рівня, 5% від 2-го рівня</div>
                                </div>
                            </div>
                            <div class="reward-item">
                                <div class="reward-icon badge-icon"></div>
                                <div class="reward-details">
                                    <div class="reward-title">Бейджі та завдання</div>
                                    <div class="reward-description">Отримуйте винагороди за бейджі та виконані завдання</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Історія бонусів -->
                    <div class="bonus-history-container">
                        <h3 class="referral-subtitle">Історія бонусів</h3>
                        <div class="bonus-history-items">
                            <p style="color: #888; text-align: center;">Завантаження історії бонусів...</p>
                        </div>
                    </div>

                    <!-- Інструкція -->
                    <div class="instructions-container">
                        <h3 class="referral-subtitle">Як це працює?</h3>
                        <div class="instructions-box">
                            <div class="instruction-step">
                                <div class="step-number">1</div>
                                <div class="step-details">
                                    <div class="step-title">Поділіться своїм посиланням</div>
                                    <div class="step-description">Відправте своє реферальне посилання друзям через месенджери або соціальні мережі</div>
                                </div>
                            </div>
                            <div class="instruction-step">
                                <div class="step-number">2</div>
                                <div class="step-details">
                                    <div class="step-title">Приведіть нових користувачів</div>
                                    <div class="step-description">Коли нові користувачі реєструються за вашим посиланням, вони стають вашими рефералами</div>
                                </div>
                            </div>
                            <div class="instruction-step">
                                <div class="step-number">3</div>
                                <div class="step-details">
                                    <div class="step-title">Отримуйте винагороди</div>
                                    <div class="step-description">Заробляйте <span class="bonus-amount">50</span> winix за кожного реферала, відсотки від їхнього прибутку та винагороди за бейджі</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ВКЛАДКА 2: БЕЙДЖІ -->
                <div class="main-tab-pane" id="badges-tab">
                    <!-- SVG для бейджів -->
                    <div style="display: none;">
                        <svg width="0" height="0">
                            <defs>
                                <!-- Градієнт для бейджу "Сміливець" -->
                                <linearGradient id="brave-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#ff7e5f" />
                                    <stop offset="100%" stop-color="#feb47b" />
                                </linearGradient>

                                <!-- Градієнт для бейджу "Новатор" -->
                                <linearGradient id="innovator-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#4eb5f7" />
                                    <stop offset="100%" stop-color="#2b6ecf" />
                                </linearGradient>

                                <!-- Градієнт для бейджу "Легенда" -->
                                <linearGradient id="legend-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#FFD700" />
                                    <stop offset="100%" stop-color="#FFA500" />
                                </linearGradient>

                                <!-- Градієнт для бейджу "Візіонер" -->
                                <linearGradient id="visionary-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" stop-color="#8E24AA" />
                                    <stop offset="100%" stop-color="#3F51B5" />
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>


                    <!-- Наступний бейдж -->
                    <div class="next-badge-container">
                        <div class="next-badge-info">
                            <div class="next-badge-title">Наступний бейдж: Сміливець</div>
                            <div class="next-badge-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: 0%"></div>
                                </div>
                                <div class="progress-text">0% (0/25)</div>
                            </div>
                            <div class="next-badge-remaining">Залишилось: 25 рефералів</div>
                        </div>
                    </div>

                    <!-- Список бейджів -->
                    <div class="badges-list-container">
                        <h3 class="referral-subtitle">Бейджі за запрошення</h3>
                        <div class="badges-list" id="badges-list">
                            <!-- Бейдж "Сміливець" (замість Бронзовий) -->
                            <div class="badge-item not-eligible">
                                <div class="badge-icon brave-icon"></div>
                                <div class="badge-info">
                                    <div class="badge-title">Сміливець</div>
                                    <div class="badge-description">Залучіть <span class="bronze-threshold">25</span> рефералів</div>
                                    <div class="badge-reward">Винагорода: <span class="bronze-reward">2500</span> winix</div>
                                    <div class="badge-progress-container">
                                        <div class="badge-progress-bar">
                                            <div class="badge-progress-fill bronze-progress" style="width: 0%"></div>
                                        </div>
                                        <div class="badge-progress-text">0% (0/25)</div>
                                    </div>
                                    <button class="claim-badge-button" data-badge="BRONZE" disabled>Недоступно</button>
                                </div>
                            </div>

                            <!-- Бейдж "Новатор" (замість Срібний) -->
                            <div class="badge-item not-eligible">
                                <div class="badge-icon innovator-icon"></div>
                                <div class="badge-info">
                                    <div class="badge-title">Новатор</div>
                                    <div class="badge-description">Залучіть <span class="silver-threshold">50</span> рефералів</div>
                                    <div class="badge-reward">Винагорода: <span class="silver-reward">5000</span> winix</div>
                                    <div class="badge-progress-container">
                                        <div class="badge-progress-bar">
                                            <div class="badge-progress-fill silver-progress" style="width: 0%"></div>
                                        </div>
                                        <div class="badge-progress-text">0% (0/50)</div>
                                    </div>
                                    <button class="claim-badge-button" data-badge="SILVER" disabled>Недоступно</button>
                                </div>
                            </div>

                            <!-- Бейдж "Легенда" (замість Золотий) -->
                            <div class="badge-item not-eligible">
                                <div class="badge-icon legend-icon"></div>
                                <div class="badge-info">
                                    <div class="badge-title">Легенда</div>
                                    <div class="badge-description">Залучіть <span class="gold-threshold">100</span> рефералів</div>
                                    <div class="badge-reward">Винагорода: <span class="gold-reward">10000</span> winix</div>
                                    <div class="badge-progress-container">
                                        <div class="badge-progress-bar">
                                            <div class="badge-progress-fill gold-progress" style="width: 0%"></div>
                                        </div>
                                        <div class="badge-progress-text">0% (0/100)</div>
                                    </div>
                                    <button class="claim-badge-button" data-badge="GOLD" disabled>Недоступно</button>
                                </div>
                            </div>

                            <!-- Бейдж "Візіонер" (замість Платиновий) -->
                            <div class="badge-item not-eligible">
                                <div class="badge-icon visionary-icon"></div>
                                <div class="badge-info">
                                    <div class="badge-title">Візіонер</div>
                                    <div class="badge-description">Залучіть <span class="platinum-threshold">500</span> рефералів</div>
                                    <div class="badge-reward">Винагорода: <span class="platinum-reward">20000</span> winix</div>
                                    <div class="badge-progress-container">
                                        <div class="badge-progress-bar">
                                            <div class="badge-progress-fill platinum-progress" style="width: 0%"></div>
                                        </div>
                                        <div class="badge-progress-text">0% (0/500)</div>
                                    </div>
                                    <button class="claim-badge-button" data-badge="PLATINUM" disabled>Недоступно</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ВКЛАДКА 3: СТАТИСТИКА -->
                <div class="main-tab-pane" id="statistics-tab">
                    <!-- Картки з показниками активності -->
                    <div class="activity-stats-container">
                        <div class="activity-stats-card">
                            <div class="activity-stats-icon active-referrals-icon"></div>
                            <div class="activity-stats-value" id="active-referrals-count">0</div>
                            <div class="activity-stats-label">Активні реферали</div>
                        </div>
                        <div class="activity-stats-card">
                            <div class="activity-stats-icon inactive-referrals-icon"></div>
                            <div class="activity-stats-value" id="inactive-referrals-count">0</div>
                            <div class="activity-stats-label">Неактивні реферали</div>
                        </div>
                        <div class="activity-stats-card">
                            <div class="activity-stats-icon conversion-rate-icon"></div>
                            <div class="activity-stats-value" id="conversion-rate">0%</div>
                            <div class="activity-stats-label">Відсоток активності</div>
                        </div>
                    </div>

                    <!-- Критерії активності -->
                    <div class="activity-criteria-container">
                        <div class="activity-criteria-title">Критерії активності рефералів</div>
                        <div class="activity-criteria-items">
                            <div class="activity-criteria-item">
                                <div class="activity-criteria-label">Мінімальна кількість розіграшів</div>
                                <div class="activity-criteria-value">3</div>
                            </div>
                            <div class="activity-criteria-item">
                                <div class="activity-criteria-label">Мінімальна кількість запрошених</div>
                                <div class="activity-criteria-value">1</div>
                            </div>
                            <div class="activity-criteria-item">
                                <div class="activity-criteria-label">Достатньо виконання хоча б одного критерію</div>
                            </div>
                        </div>
                    </div>

                    <!-- Таблиця активності рефералів -->
                    <div class="referral-activity-table">
                        <div class="activity-table-header">
                            <div class="activity-table-col activity-col-id">ID реферала</div>
                            <div class="activity-table-col activity-col-draws">Розіграші</div>
                            <div class="activity-table-col activity-col-invited">Запрошені</div>
                            <div class="activity-table-col activity-col-status">Статус</div>
                        </div>
                        <div class="activity-table-body" id="activity-table-body">
                            <p style="color: #888; text-align: center; padding: 20px;">Завантаження даних про активність...</p>
                        </div>
                    </div>

                    <!-- Рекомендації щодо активності -->
                    <div class="activity-recommendations">
                        <div class="recommendations-title">Рекомендації</div>
                        <div class="recommendations-list" id="activity-recommendations">
                            <p style="color: white; margin-bottom: 10px;">Заохочуйте рефералів брати участь у розіграшах (мінімум 3 для активності).</p>
                            <p style="color: white;">Мотивуйте рефералів запрошувати інших користувачів (достатньо 1 запрошення для активності).</p>
                        </div>
                    </div>

                    <!-- Структура рефералів -->
                    <div class="referral-structure-container">
                        <h3 class="referral-subtitle">Структура рефералів</h3>
                        <div class="structure-info">
                            <div class="structure-item">
                                <div class="structure-label">Загальна кількість</div>
                                <div class="structure-value total-referrals-count">0</div>
                            </div>
                            <div class="structure-item">
                                <div class="structure-label">Активні реферали</div>
                                <div class="structure-value active-referrals-count">0</div>
                            </div>
                            <div class="structure-item">
                                <div class="structure-label">% конверсії</div>
                                <div class="structure-value conversion-rate">0%</div>
                            </div>
                        </div>

                        <!-- Вкладки для перегляду рефералів -->
                        <div class="referral-tabs">
                            <div class="referral-tab active" data-tab="level1">1-й рівень</div>
                            <div class="referral-tab" data-tab="level2">2-й рівень</div>
                        </div>

                        <!-- Контент вкладок -->
                        <div class="referral-tab-content">
                            <!-- Вкладка рефералів 1-го рівня -->
                            <div class="tab-pane active" id="level1-tab">
                                <div class="referral-list" id="level1-list">
                                    <p style="color: #888; text-align: center;">Завантаження рефералів 1-го рівня...</p>
                                </div>
                            </div>

                            <!-- Вкладка рефералів 2-го рівня -->
                            <div class="tab-pane" id="level2-tab">
                                <div class="referral-list" id="level2-list">
                                    <p style="color: #888; text-align: center;">Завантаження рефералів 2-го рівня...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Деталі реферала (показується при кліку на реферала) -->
            <div class="referral-details" id="referral-details">
                <div class="referral-details-header">
                    <div class="referral-details-title">Інформація про реферала</div>
                    <div class="referral-details-close">&times;</div>
                </div>
                <div class="referral-details-content">
                    <div class="detail-item">
                        <div class="detail-label">ID</div>
                        <div class="detail-value" id="detail-id">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Дата реєстрації</div>
                        <div class="detail-value" id="detail-date">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Статус</div>
                        <div class="detail-value" id="detail-status">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Заробіток</div>
                        <div class="detail-value" id="detail-earnings">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Останнє відвідування</div>
                        <div class="detail-value" id="detail-last-activity">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Кількість рефералів</div>
                        <div class="detail-value" id="detail-referral-count">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Участь в розіграшах</div>
                        <div class="detail-value" id="detail-draws">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Запрошені реферали</div>
                        <div class="detail-value" id="detail-invited">-</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Причина активності</div>
                        <div class="detail-value" id="detail-activity-reason">-</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Нижня навігаційна панель -->
        <nav class="nav-bar">
             <div class="nav-item" data-section="home">
                <div class="icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 22V12H15V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span>Home</span>
            </div>
            <div class="nav-item" data-section="earn">
                <div class="icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span>Earn</span>
            </div>
            <div class="nav-item active" data-section="referrals">
                <div class="icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 3.13C16.8604 3.35031 17.623 3.85071 18.1676 4.55232C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89318 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span>Referral</span>
            </div>
            <div class="nav-item" data-section="wallet">
                <div class="icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M21 8.5C21 7.83696 20.7366 7.20107 20.2678 6.73223C19.7989 6.26339 19.163 6 18.5 6H5.5C4.83696 6 4.20107 6.26339 3.73223 6.73223C3.26339 7.20107 3 7.83696 3 8.5M21 8.5V15.5C21 16.163 20.7366 16.7989 20.2678 17.2678C19.7989 17.7366 19.163 18 18.5 18H5.5C4.83696 18 4.20107 17.7366 3.73223 17.2678C3.26339 16.7989 3 16.163 3 15.5V8.5M21 8.5L12 13L3 8.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 10L12 17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M16 14L8 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span>Wallet</span>
            </div>
            <div class="nav-item" data-section="general">
                <div class="icon-wrapper">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 1V9M12 15V23M4.22 4.22L8.46 8.46M15.54 15.54L19.78 19.78M1 12H9M15 12H23M4.22 19.78L8.46 15.54M15.54 8.46L19.78 4.22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <span>General</span>
            </div>
        </nav>
    </div>

    <!-- Повідомлення про копіювання -->
    <div class="toast-message" id="copy-toast">
        Посилання скопійовано!
    </div>

    <style>
        .toast-message.warning {
            background-color: #ff9800;
            color: white;
        }

        .toast-message.error {
            background-color: #f44336;
            color: white;
        }

        .toast-message.success {
            background-color: #4caf50;
            color: white;
        }
    </style>

    <!-- Основні скрипти -->
    <script src="js/telegram-web-app.js"></script>

    <script>
        // Ініціалізація та перевірка Telegram WebApp
        (function() {
            console.log("🔄 [TELEGRAM-INIT] ===== ПОЧАТОК ІНІЦІАЛІЗАЦІЇ TELEGRAM WEBAPP =====");
            console.log("🕐 [TELEGRAM-INIT] Час:", new Date().toISOString());
            console.log("📊 [TELEGRAM-INIT] Перевірка глобальних об'єктів:", {
                hasTelegram: typeof window.Telegram !== 'undefined',
                hasWebApp: window.Telegram && typeof window.Telegram.WebApp !== 'undefined'
            });

            if (!window.Telegram || !window.Telegram.WebApp) {
                console.error("❌ [TELEGRAM-INIT] Telegram WebApp API не завантажено!");
                console.error("❌ [TELEGRAM-INIT] window.Telegram:", window.Telegram);
                return;
            }

            try {
                console.log("🔄 [TELEGRAM-INIT] Виклик Telegram.WebApp.ready()...");
                window.Telegram.WebApp.ready();

                console.log("🔄 [TELEGRAM-INIT] Виклик Telegram.WebApp.expand()...");
                window.Telegram.WebApp.expand();

                console.log("✅ [TELEGRAM-INIT] Telegram WebApp успішно ініціалізовано");
                console.log("📊 [TELEGRAM-INIT] WebApp дані:", {
                    version: window.Telegram.WebApp.version,
                    platform: window.Telegram.WebApp.platform,
                    colorScheme: window.Telegram.WebApp.colorScheme,
                    themeParams: window.Telegram.WebApp.themeParams,
                    initDataUnsafe: window.Telegram.WebApp.initDataUnsafe
                });

                if (window.Telegram.WebApp.initDataUnsafe && window.Telegram.WebApp.initDataUnsafe.user) {
                    const user = window.Telegram.WebApp.initDataUnsafe.user;
                    console.log("👤 [TELEGRAM-INIT] Дані користувача:", {
                        id: user.id,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        username: user.username,
                        language_code: user.language_code
                    });

                    const userId = parseInt(user.id);
                    localStorage.setItem('telegram_user_id', userId.toString());
                    console.log("✅ [TELEGRAM-INIT] ID збережено в localStorage:", userId);

                    // Одразу встановлюємо ID в DOM
                    setTimeout(function() {
                        console.log("🔄 [TELEGRAM-INIT] Оновлення ID в DOM...");
                        const userIdElements = document.querySelectorAll('.user-id-value');
                        userIdElements.forEach(function(element, index) {
                            console.log(`  🔄 [TELEGRAM-INIT] Оновлення елемента ${index}:`, element);
                            element.textContent = userId;
                        });
                    }, 100);
                } else {
                    console.warn("⚠️ [TELEGRAM-INIT] Дані користувача відсутні в Telegram WebApp");
                    console.log("📊 [TELEGRAM-INIT] initDataUnsafe:", window.Telegram.WebApp.initDataUnsafe);
                }
            } catch (e) {
                console.error("❌ [TELEGRAM-INIT] КРИТИЧНА ПОМИЛКА ініціалізації Telegram WebApp:", e);
                console.error("❌ [TELEGRAM-INIT] Stack trace:", e.stack);
            }

            console.log("✅ [TELEGRAM-INIT] ===== КІНЕЦЬ ІНІЦІАЛІЗАЦІЇ TELEGRAM WEBAPP =====");
        })();
    </script>

    <script src="./js/api.js"></script>
    <script src="./js/referrals/api.js"></script>
    <script src="./js/auth.js"></script>
    <script src="./js/core.js"></script>

    <!-- Реферальні модулі - виправлені JS файли -->
    <script src="./js/referrals/constants.js"></script>
    <script src="./js/referrals/utils.js"></script>
    <script src="./js/referrals/services.js"></script>
    <script src="./js/referrals/store.js"></script>
    <script src="./js/referrals/Integration.js"></script>

    <!-- Ініціалізація реферальної системи -->
    <script>
        console.log("🌟 [MAIN] ===== ПОЧАТОК ГОЛОВНОГО СКРИПТУ =====");
        console.log("🕐 [MAIN] Час:", new Date().toISOString());

        function safeInitReferralModules() {
            console.log("🔄 [MAIN] ===== safeInitReferralModules START =====");

            try {
                console.log("📊 [MAIN] Перевірка завантажених модулів...");

                // Перевіряємо чи всі модулі завантажені
                const moduleChecks = {
                    ReferralConstants: typeof window.ReferralConstants !== 'undefined',
                    ReferralUtils: typeof window.ReferralUtils !== 'undefined',
                    ReferralServices: typeof window.ReferralServices !== 'undefined',
                    ReferralAPI: typeof window.ReferralAPI !== 'undefined',
                    ReferralStore: typeof window.ReferralStore !== 'undefined',
                    initReferralSystem: typeof window.initReferralSystem === 'function'
                };

                console.log("📊 [MAIN] Статус модулів:", moduleChecks);

                const missingModules = [];
                Object.keys(moduleChecks).forEach(function(moduleName) {
                    if (!moduleChecks[moduleName]) {
                        missingModules.push(moduleName);
                    }
                });

                if (missingModules.length > 0) {
                    console.error("❌ [MAIN] КРИТИЧНА ПОМИЛКА: Відсутні модулі:", missingModules);
                    showErrorToast('Помилка завантаження модулів: ' + missingModules.join(', '));
                    return;
                }

                console.log("✅ [MAIN] Усі модулі завантажено успішно!");

                // Детальна перевірка кожного модуля
                console.log("📊 [MAIN] Детальна інформація про модулі:");
                console.log("  - ReferralConstants:", {
                    type: typeof window.ReferralConstants,
                    properties: Object.keys(window.ReferralConstants || {}).length
                });
                console.log("  - ReferralUtils:", {
                    type: typeof window.ReferralUtils,
                    methods: Object.keys(window.ReferralUtils || {}).length
                });
                console.log("  - ReferralServices:", {
                    type: typeof window.ReferralServices,
                    methods: Object.keys(window.ReferralServices || {}).length
                });
                console.log("  - ReferralAPI:", {
                    type: typeof window.ReferralAPI,
                    methods: Object.keys(window.ReferralAPI || {}).length
                });
                console.log("  - ReferralStore:", {
                    type: typeof window.ReferralStore,
                    properties: Object.keys(window.ReferralStore || {}).length
                });

                // Перевіряємо наявність API
                console.log("🏥 [MAIN] Перевірка доступності API...");
                if (window.ReferralAPI && window.ReferralAPI.checkAPIHealth) {
                    window.ReferralAPI.checkAPIHealth()
                        .then(function(isHealthy) {
                            console.log("🏥 [MAIN] Результат перевірки API:", isHealthy);
                            if (!isHealthy) {
                                console.warn("⚠️ [MAIN] API недоступний або має проблеми");
                                showErrorToast('API сервер недоступний. Перевірте підключення.');
                            }
                            startReferralSystem();
                        })
                        .catch(function(error) {
                            console.error("❌ [MAIN] Помилка перевірки API:", error);
                            showErrorToast('Не вдалося підключитися до сервера.');
                            // Все одно намагаємося запустити систему
                            startReferralSystem();
                        });
                } else {
                    console.log("⚠️ [MAIN] checkAPIHealth недоступний, пропускаємо перевірку");
                    startReferralSystem();
                }

            } catch (error) {
                console.error("❌ [MAIN] КРИТИЧНА ПОМИЛКА в safeInitReferralModules:", error);
                console.error("❌ [MAIN] Stack trace:", error.stack);
                showErrorToast('Критична помилка ініціалізації');
            }
        }

        function startReferralSystem() {
            console.log("🚀 [MAIN] ===== startReferralSystem START =====");
            console.log("🕐 [MAIN] Час:", new Date().toISOString());

            // Перевіряємо наявність ID користувача
            const userId = getUserId();
            console.log("👤 [MAIN] ID користувача для запуску:", userId);

            if (!userId) {
                console.error("❌ [MAIN] ID користувача відсутній! Неможливо запустити систему");
                showErrorToast('Не вдалося отримати ID користувача. Спробуйте перезавантажити сторінку.');
                return;
            }

            // Запускаємо ініціалізацію реферальної системи
            console.log("🔄 [MAIN] Виклик window.initReferralSystem()...");

            window.initReferralSystem()
                .then(function(integration) {
                    console.log("🎉 [MAIN] ===== РЕФЕРАЛЬНА СИСТЕМА УСПІШНО ІНІЦІАЛІЗОВАНА =====");
                    console.log("📊 [MAIN] Отриманий об'єкт integration:", {
                        type: typeof integration,
                        hasInit: typeof integration.init === 'function',
                        userId: integration.userId,
                        isInitialized: integration.isInitialized
                    });

                    // Додаємо глобальні функції для налагодження
                    window.debugReferrals = {
                        integration: integration,
                        constants: window.ReferralConstants,
                        utils: window.ReferralUtils,
                        services: window.ReferralServices,
                        api: window.ReferralAPI,
                        store: window.ReferralStore,
                        getState: function() {
                            if (integration && integration.store) {
                                return integration.store.getState();
                            }
                            return null;
                        },
                        reload: function() {
                            console.log("🔄 [DEBUG] Перезавантаження даних...");
                            if (integration && integration.loadInitialData) {
                                return integration.loadInitialData();
                            }
                        }
                    };

                    console.log("🔍 [MAIN] Налагоджувальні функції додано в window.debugReferrals");
                    console.log("💡 [MAIN] Підказка: використовуйте window.debugReferrals для налагодження");
                })
                .catch(function(error) {
                    console.error("❌ [MAIN] ===== ПОМИЛКА ІНІЦІАЛІЗАЦІЇ РЕФЕРАЛЬНОЇ СИСТЕМИ =====");
                    console.error("❌ [MAIN] Тип помилки:", error.name);
                    console.error("❌ [MAIN] Повідомлення:", error.message);
                    console.error("❌ [MAIN] Stack trace:", error.stack);
                    showErrorToast('Помилка ініціалізації системи: ' + error.message);
                });
        }

        function getUserId() {
            console.log("🔍 [MAIN] === getUserId START ===");

            // Спочатку пробуємо з Telegram
            if (window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
                const tgId = parseInt(window.Telegram.WebApp.initDataUnsafe.user.id);
                console.log("✅ [MAIN] ID з Telegram WebApp:", tgId);
                return tgId;
            }

            // Потім з localStorage
            const telegramId = localStorage.getItem('telegram_user_id');
            const userId = localStorage.getItem('user_id');

            console.log("📊 [MAIN] ID з localStorage:", {
                telegram_user_id: telegramId,
                user_id: userId
            });

            const storedId = telegramId || userId;
            if (storedId) {
                const numericId = parseInt(storedId);
                if (!isNaN(numericId)) {
                    console.log("✅ [MAIN] ID з localStorage:", numericId);
                    return numericId;
                }
            }

            // Демо режим - показуємо попередження
            console.error('❌ [MAIN] ID користувача не знайдено в жодному джерелі!');
            showErrorToast('Не вдалося отримати дані користувача');
            return null;
        }

        function showErrorToast(message) {
            console.log("🔴 [MAIN] Показ помилки:", message);
            const toast = document.getElementById('copy-toast');
            if (toast) {
                toast.textContent = message;
                toast.classList.add('show', 'error');
                setTimeout(function() {
                    toast.classList.remove('show', 'error');
                }, 5000);
            }
        }

        // Запускаємо ініціалізацію після завантаження DOM
        console.log("📊 [MAIN] document.readyState:", document.readyState);

        if (document.readyState === 'loading') {
            console.log("⏳ [MAIN] Очікуємо завантаження DOM...");
            document.addEventListener('DOMContentLoaded', function() {
                console.log("✅ [MAIN] DOM завантажено, запускаємо ініціалізацію");
                safeInitReferralModules();
            });
        } else {
            console.log("✅ [MAIN] DOM вже завантажено, запускаємо ініціалізацію");
            safeInitReferralModules();
        }
    </script>

    <!-- Вбудований скрипт для ініціалізації базової функціональності -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("🎯 [BASE-HANDLERS] ===== ІНІЦІАЛІЗАЦІЯ БАЗОВИХ ОБРОБНИКІВ ПОДІЙ =====");
            console.log("🕐 [BASE-HANDLERS] Час:", new Date().toISOString());

            // 1. Обробник для кнопки копіювання посилання
            const copyButton = document.querySelector('.copy-button');
            console.log("🔍 [BASE-HANDLERS] Пошук кнопки копіювання:", {
                found: !!copyButton,
                element: copyButton
            });

            if (copyButton) {
                copyButton.addEventListener('click', function() {
                    console.log('📋 [BASE-HANDLERS] === КЛІК НА КНОПКУ КОПІЮВАННЯ ===');

                    const linkDisplay = document.querySelector('.link-display');
                    const linkText = linkDisplay ? linkDisplay.textContent : null;

                    console.log('📊 [BASE-HANDLERS] Дані для копіювання:', {
                        hasLinkDisplay: !!linkDisplay,
                        linkText: linkText,
                        isLoading: linkText === 'Завантаження...'
                    });

                    if (linkText && linkText !== 'Завантаження...') {
                        console.log('🔄 [BASE-HANDLERS] Спроба копіювання...');

                        if (navigator.clipboard && navigator.clipboard.writeText) {
                            console.log('📋 [BASE-HANDLERS] Використання Clipboard API...');

                            navigator.clipboard.writeText(linkText)
                                .then(function() {
                                    console.log('✅ [BASE-HANDLERS] Успішно скопійовано через Clipboard API');
                                    showSuccessToast('Посилання скопійовано!');
                                    copyButton.classList.add('clicked');
                                    setTimeout(function() {
                                        copyButton.classList.remove('clicked');
                                    }, 300);
                                })
                                .catch(function(err) {
                                    console.error('❌ [BASE-HANDLERS] Помилка Clipboard API:', err);
                                    showErrorToast('Помилка копіювання');
                                });
                        } else {
                            // Fallback для старих браузерів
                            console.log('📋 [BASE-HANDLERS] Fallback метод копіювання...');
                            try {
                                const textArea = document.createElement('textarea');
                                textArea.value = linkText;
                                document.body.appendChild(textArea);
                                textArea.select();
                                const success = document.execCommand('copy');
                                document.body.removeChild(textArea);

                                console.log('📋 [BASE-HANDLERS] Результат execCommand:', success);

                                if (success) {
                                    showSuccessToast('Посилання скопійовано!');
                                } else {
                                    showErrorToast('Помилка копіювання');
                                }
                            } catch (err) {
                                console.error('❌ [BASE-HANDLERS] Помилка fallback методу:', err);
                                showErrorToast('Помилка копіювання');
                            }
                        }
                    } else {
                        console.warn('⚠️ [BASE-HANDLERS] Посилання ще не готове');
                        showErrorToast('Посилання ще завантажується');
                    }
                });
                console.log("✅ [BASE-HANDLERS] Обробник для кнопки копіювання встановлено");
            }

            function showSuccessToast(message) {
                console.log('✅ [BASE-HANDLERS] Показ успішного повідомлення:', message);
                const toast = document.getElementById('copy-toast');
                if (toast) {
                    toast.textContent = message;
                    toast.classList.add('show', 'success');
                    setTimeout(function() {
                        toast.classList.remove('show', 'success');
                    }, 3000);
                }
            }

            function showErrorToast(message) {
                console.log('❌ [BASE-HANDLERS] Показ повідомлення про помилку:', message);
                const toast = document.getElementById('copy-toast');
                if (toast) {
                    toast.textContent = message;
                    toast.classList.add('show', 'error');
                    setTimeout(function() {
                        toast.classList.remove('show', 'error');
                    }, 3000);
                }
            }

            // 2. Обробники для внутрішніх вкладок рефералів (тільки 1-й і 2-й рівень)
            const tabs = document.querySelectorAll('.referral-tab');
            console.log("🔍 [BASE-HANDLERS] Знайдено внутрішніх вкладок:", tabs.length);

            tabs.forEach(function(tab, index) {
                tab.addEventListener('click', function() {
                    const tabId = tab.dataset.tab;
                    console.log(`📑 [BASE-HANDLERS] Клік на внутрішню вкладку ${index}:`, tabId);

                    // Перевіряємо чи це валідна вкладка (тільки level1 або level2)
                    if (tabId !== 'level1' && tabId !== 'level2') {
                        console.warn("⚠️ [BASE-HANDLERS] Невідома вкладка:", tabId);
                        return;
                    }

                    // Видаляємо клас active з усіх вкладок
                    tabs.forEach(function(t) {
                        t.classList.remove('active');
                    });

                    // Додаємо клас active до обраної вкладки
                    tab.classList.add('active');

                    // Приховуємо всі панелі
                    const panes = document.querySelectorAll('.tab-pane');
                    panes.forEach(function(pane) {
                        pane.classList.remove('active');
                    });

                    // Показуємо відповідну панель
                    const activePane = document.getElementById(tabId + '-tab');
                    if (activePane) {
                        activePane.classList.add('active');
                        console.log("✅ [BASE-HANDLERS] Активовано внутрішню панель:", tabId);
                    }
                });
            });
            console.log("✅ [BASE-HANDLERS] Обробники для внутрішніх вкладок встановлено");

            // 3. Обробники для головних вкладок
            const mainTabs = document.querySelectorAll('.main-tabs .tab-button');
            console.log("🔍 [BASE-HANDLERS] Знайдено головних вкладок:", mainTabs.length);

            mainTabs.forEach(function(tab, index) {
                tab.addEventListener('click', function() {
                    console.log(`📑 [BASE-HANDLERS] Клік на головну вкладку ${index}:`, tab.dataset.tab);

                    // Видаляємо клас active з усіх вкладок
                    mainTabs.forEach(function(t) {
                        t.classList.remove('active');
                    });

                    // Додаємо клас active до обраної вкладки
                    tab.classList.add('active');

                    // Отримуємо ідентифікатор вкладки
                    const tabId = tab.dataset.tab;

                    // Приховуємо всі панелі
                    const panes = document.querySelectorAll('.main-tab-pane');
                    panes.forEach(function(pane) {
                        pane.classList.remove('active');
                    });

                    // Показуємо відповідну панель
                    const activePane = document.getElementById(tabId + '-tab');
                    if (activePane) {
                        activePane.classList.add('active');
                        console.log("✅ [BASE-HANDLERS] Активовано головну панель:", tabId);
                    }
                });
            });
            console.log("✅ [BASE-HANDLERS] Обробники для головних вкладок встановлено");

            // 4. Обробник для кнопки закриття деталей реферала
            const closeButton = document.querySelector('.referral-details-close');
            console.log("🔍 [BASE-HANDLERS] Кнопка закриття деталей:", !!closeButton);

            if (closeButton) {
                closeButton.addEventListener('click', function() {
                    console.log("❌ [BASE-HANDLERS] Закриття деталей реферала");
                    const detailsContainer = document.getElementById('referral-details');
                    if (detailsContainer) {
                        detailsContainer.classList.remove('show');
                        console.log("✅ [BASE-HANDLERS] Деталі реферала приховано");
                    }
                });
                console.log("✅ [BASE-HANDLERS] Обробник для кнопки закриття деталей встановлено");
            }

            // 5. Обробники для нижньої навігації
const navItems = document.querySelectorAll('.nav-bar .nav-item');
console.log("🔍 [BASE-HANDLERS] Елементи навігації:", navItems.length);

navItems.forEach(function(item) {
    item.addEventListener('click', function(e) {
        e.preventDefault();
        const section = this.getAttribute('data-section');
        console.log("📍 [BASE-HANDLERS] Перехід до секції:", section);

        // Визначаємо URL для кожної секції
        let targetUrl = '';
        switch(section) {
            case 'home':
                targetUrl = 'original-index.html';
                break;
            case 'earn':
                targetUrl = 'earn.html';
                break;
            case 'referrals':
                // Поточна сторінка - нічого не робимо
                console.log("📍 [BASE-HANDLERS] Вже на сторінці рефералів");
                return;
            case 'wallet':
                targetUrl = 'wallet.html';
                break;
            case 'general':
                targetUrl = 'general.html';
                break;
            default:
                console.error("❌ [BASE-HANDLERS] Невідома секція:", section);
                return;
        }

        if (targetUrl) {
            console.log("🚀 [BASE-HANDLERS] Перенаправлення на:", targetUrl);
            window.location.href = targetUrl;
        }
    });
});
console.log("✅ [BASE-HANDLERS] Обробники для нижньої навігації встановлено");

            console.log("🎉 [BASE-HANDLERS] ===== БАЗОВІ ОБРОБНИКИ ПОДІЙ УСПІШНО ІНІЦІАЛІЗОВАНО =====");
        });
    </script>
</body>
</html>