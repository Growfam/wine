/**
 * index.js - –ì–æ–ª–æ–≤–Ω–∏–π —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–∏–π –º–æ–¥—É–ª—å –¥–ª—è –≤—Å—ñ—Ö —Ñ—É–Ω–∫—Ü—ñ–π —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ–≤
 * –û–±'—î–¥–Ω—É—î –≤—Å—ñ –ø—ñ–¥–º–æ–¥—É–ª—ñ —Ç–∞ –µ–∫—Å–ø–æ—Ä—Ç—É—î —î–¥–∏–Ω–∏–π —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —Ä–æ–∑—ñ–≥—Ä–∞—à–∞–º–∏
 */

import WinixRaffles from './globals.js';
import activeRaffles from './modules/active.js';
import history from './modules/history.js';
import stats from './modules/stats.js';
import cards from './components/cards.js';
import participation from './modules/participation.js';
import modals from './components/modals.js';
import admin from './admin/index.js';
import {
    formatDate,
    formatCurrency,
    formatNumber
} from './utils/formatters.js';
import {
    showToast,
    showLoading,
    hideLoading,
    showConfirm
} from './utils/ui-helpers.js';

/**
 * –ö–ª–∞—Å –¥–ª—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –º–æ–¥—É–ª—è–º–∏ —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ–≤ —ñ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —î–¥–∏–Ω–æ—ó —Ç–æ—á–∫–∏ –≤—Ö–æ–¥—É
 */
class RafflesModule {
    constructor() {
        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ø—ñ–¥–º–æ–¥—É–ª—ñ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —ó—Ö —Ñ—É–Ω–∫—Ü—ñ–π
        this.activeRaffles = activeRaffles;
        this.history = history;
        this.stats = stats;
        this.cards = cards;
        this.participation = participation;
        this.modals = modals;
        this.admin = admin;

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ —É—Ç–∏–ª—ñ—Ç–∏ –¥–ª—è –∑—Ä—É—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É
        this.formatters = {
            formatDate,
            formatCurrency,
            formatNumber
        };

        this.ui = {
            showToast,
            showLoading,
            hideLoading,
            showConfirm
        };

        // –ü—Ä–∞–ø–æ—Ä–µ—Ü—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        this._initialized = false;

        // –°–ø–∏—Å–æ–∫ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        this._eventListeners = [];
    }

    /**
     * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –≤—Å—ñ—Ö –º–æ–¥—É–ª—ñ–≤ —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ–≤
     */
    init() {
        if (this._initialized) {
            console.warn("Raffles Module: –ú–æ–¥—É–ª—å —É–∂–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–æ");
            return this;
        }

        console.log("üéÆ Raffles Module: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –º–æ–¥—É–ª—è —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ–≤");

        // –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
        this._initTabSwitching();

        // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –ø—ñ–¥–º–æ–¥—É–ª—ñ
        this.activeRaffles.init();
        this.history.init();
        this.modals.init();
        this.stats.init();
        this.participation.init();

        // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        this._checkAdminAccess();

        // –ü—ñ–¥–ø–∏—Å—É—î–º–æ—Å—è –Ω–∞ –ø–æ–¥—ñ—ó
        this._setupEventListeners();

        // –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –≥–ª–æ–±–∞–ª—å–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó
        this.exportGlobalFunctions();

        // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        this._initialized = true;

        console.log("‚úÖ Raffles Module: –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –∑–∞–≤–µ—Ä—à–µ–Ω–æ");

        return this;
    }

    /**
     * –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –º—ñ–∂ –≤–∫–ª–∞–¥–∫–∞–º–∏ —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ–≤
     * @param {string} tabName - –ù–∞–∑–≤–∞ –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó
     */
    switchTab(tabName) {
        console.log(`üéÆ Raffles: –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É ${tabName}`);

        // –û–Ω–æ–≤–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—É –≤–∫–ª–∞–¥–∫—É
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabSections = document.querySelectorAll('.tab-content');

        // –ó–Ω—ñ–º–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π —Å—Ç–∞–Ω –∑ —É—Å—ñ—Ö –≤–∫–ª–∞–¥–æ–∫ —ñ —Å–µ–∫—Ü—ñ–π
        tabButtons.forEach(btn => btn.classList.remove('active'));
        tabSections.forEach(section => section.classList.remove('active'));

        // –î–æ–¥–∞—î–º–æ –∞–∫—Ç–∏–≤–Ω–∏–π —Å—Ç–∞–Ω –¥–æ –≤–∏–±—Ä–∞–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏ —ñ —Å–µ–∫—Ü—ñ—ó
        const activeTabButton = document.querySelector(`.tab-button[data-tab="${tabName}"]`);
        const activeTabSection = document.getElementById(`${tabName}-raffles`);

        if (activeTabButton) activeTabButton.classList.add('active');
        if (activeTabSection) activeTabSection.classList.add('active');

        // –ï–º—ñ—Ç—É—î–º–æ –ø–æ–¥—ñ—é –ø—Ä–æ –∑–º—ñ–Ω—É –≤–∫–ª–∞–¥–∫–∏
        WinixRaffles.events.emit('tab-switched', { tab: tabName });

        // –í–∏–∫–ª–∏–∫–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó –≤ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ –≤—ñ–¥ –≤–∫–ª–∞–¥–∫–∏
        if (tabName === 'past' || tabName === 'history') {
            this.history.displayHistory('history-container');
        } else if (tabName === 'active') {
            this.activeRaffles.displayRaffles();
        } else if (tabName === 'stats') {
            this.stats.displayUserStats('user-stats-container');
        } else if (tabName === 'admin' && this._isAdmin) {
            this.admin.displayRafflesList();
        }
    }

    /**
     * –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞—è–≤–Ω–æ—Å—Ç—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—Å—å–∫–∏—Ö –ø—Ä–∞–≤
     * @private
     */
    async _checkAdminAccess() {
        try {
            // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –º–æ–¥—É–ª—è AdminAPI
            if (window.AdminAPI && typeof window.AdminAPI.getAdminId === 'function') {
                const adminId = window.AdminAPI.getAdminId();
                if (adminId) {
                    this._isAdmin = true;

                    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏–π –º–æ–¥—É–ª—å
                    if (document.getElementById('admin-raffles-container')) {
                        this.admin.init();
                    }

                    console.log("üëë Raffles Module: –í–∏—è–≤–ª–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—Å—å–∫—ñ –ø—Ä–∞–≤–∞");
                }
            }
        } catch (error) {
            console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø—É:', error);
            this._isAdmin = false;
        }
    }

    /**
     * –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ñ—É–Ω–∫—Ü—ñ–π –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
     * @private
     */
    _initTabSwitching() {
        // –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –¥–ª—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –≤–∫–ª–∞–¥–æ–∫
        const tabButtons = document.querySelectorAll('.tab-button');
        if (tabButtons.length > 0) {
            tabButtons.forEach(button => {
                const clickHandler = () => {
                    const tabName = button.getAttribute('data-tab');
                    this.switchTab(tabName);
                };

                button.addEventListener('click', clickHandler);

                // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
                this._eventListeners.push({
                    element: button,
                    event: 'click',
                    handler: clickHandler
                });
            });
        }
    }

    /**
     * –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
     * @private
     */
    _setupEventListeners() {
        // –û–±—Ä–æ–±–Ω–∏–∫ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó —Å–µ—Ä–≤—ñ—Å—É
        const initHandler = () => {
            if (!this._initialized) {
                this.init();
            }
        };

        document.addEventListener('winix-initialized', initHandler);

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        this._eventListeners.push({
            element: document,
            event: 'winix-initialized',
            handler: initHandler
        });

        // –û–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ—ó –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        const userDataHandler = (event) => {
            if (event.detail && event.detail.isAdmin) {
                this._isAdmin = true;
                // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–∏–π –º–æ–¥—É–ª—å, —è–∫—â–æ –¥–æ—Å—Ç—É–ø–Ω–∏–π
                if (document.getElementById('admin-raffles-container') && this.admin) {
                    this.admin.init();
                }
            }
        };

        document.addEventListener('user-data-updated', userDataHandler);

        // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫ –¥–ª—è –º–æ–∂–ª–∏–≤–æ—Å—Ç—ñ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
        this._eventListeners.push({
            element: document,
            event: 'user-data-updated',
            handler: userDataHandler
        });
    }

    /**
     * –í–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π
     * @private
     */
    _removeEventListeners() {
        // –í–∏–¥–∞–ª—è—î–º–æ –≤—Å—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –æ–±—Ä–æ–±–Ω–∏–∫–∏
        this._eventListeners.forEach(listener => {
            if (listener.element) {
                listener.element.removeEventListener(listener.event, listener.handler);
            }
        });

        // –û—á–∏—â–∞—î–º–æ –º–∞—Å–∏–≤
        this._eventListeners = [];
    }

    /**
     * –ï–∫—Å–ø–æ—Ä—Ç –≤—Å—ñ—Ö –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π –¥–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤ —ñ–Ω—à–∏—Ö –º–æ–¥—É–ª—è—Ö
     */
    exportGlobalFunctions() {
        window.rafflesModule = this;

        // –î–æ–¥–∞—î–º–æ —Ñ—É–Ω–∫—Ü—ñ—ó –¥–ª—è –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
        window.openRaffleDetails = (raffleId, raffleType) => {
            WinixRaffles.events.emit('open-raffle-details', { raffleId, raffleType });
        };

        window.showRaffleHistoryDetails = (raffleData) => {
            WinixRaffles.events.emit('show-history-details', { raffleData });
        };

        // –°—Ç–≤–æ—Ä—é—î–º–æ –æ–±'—î–∫—Ç rafflesFunctions –¥–ª—è –∑–≤–æ—Ä–æ—Ç–Ω–æ—ó —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ –∑—ñ —Å—Ç–∞—Ä–∏–º –∫–æ–¥–æ–º
        window.rafflesFunctions = {
            switchTab: this.switchTab.bind(this),
            loadRaffleHistory: this.history.displayHistory.bind(this.history),
            resetAllStates: this.resetAllStates.bind(this)
        };

        return this;
    }

    /**
     * –°–∫–∏–¥–∞–Ω–Ω—è –≤—Å—ñ—Ö —Å—Ç–∞–Ω—ñ–≤
     */
    resetAllStates() {
        // –°–∫–∏–¥–∞–Ω–Ω—è —Å—Ç–∞–Ω—ñ–≤ —É –≤—Å—ñ—Ö –º–æ–¥—É–ª—è—Ö
        this.activeRaffles.resetAllStates();

        if (this.history && typeof this.history.resetRequestState === 'function') {
            this.history.resetRequestState();
        }

        // –ó–∞–∫—Ä–∏—Ç—Ç—è –≤—Å—ñ—Ö –º–æ–¥–∞–ª—å–Ω–∏—Ö –≤—ñ–∫–æ–Ω
        this.modals.closeAllModals();

        // –ü—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è –ª–æ–∞–¥–µ—Ä—ñ–≤
        WinixRaffles.loader.hideAll();

        return this;
    }

    /**
     * –ó–Ω–∏—â–µ–Ω–Ω—è –º–æ–¥—É–ª—è —ñ –∑–≤—ñ–ª—å–Ω–µ–Ω–Ω—è —Ä–µ—Å—É—Ä—Å—ñ–≤
     */
    destroy() {
        if (!this._initialized) {
            return this;
        }

        console.log("üö´ Raffles Module: –ó–Ω–∏—â–µ–Ω–Ω—è –º–æ–¥—É–ª—ñ–≤ —Ä–æ–∑—ñ–≥—Ä–∞—à—ñ–≤");

        // –°–∫–∏–¥–∞—î–º–æ –≤—Å—ñ —Å—Ç–∞–Ω–∏
        this.resetAllStates();

        // –í–∏–¥–∞–ª—è—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        this._removeEventListeners();

        // –ó–Ω–∏—â—É—î–º–æ –ø—ñ–¥–º–æ–¥—É–ª—ñ
        if (this.activeRaffles && typeof this.activeRaffles.destroy === 'function') {
            this.activeRaffles.destroy();
        }

        if (this.history && typeof this.history.destroy === 'function') {
            this.history.destroy();
        }

        if (this.stats && typeof this.stats.destroy === 'function') {
            this.stats.destroy();
        }

        if (this.modals && typeof this.modals.destroy === 'function') {
            this.modals.destroy();
        }

        if (this.participation && typeof this.participation.destroy === 'function') {
            this.participation.destroy();
        }

        if (this.admin && typeof this.admin.destroy === 'function') {
            this.admin.destroy();
        }

        // –°–∫–∏–¥–∞—î–º–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó
        this._initialized = false;

        console.log("‚úÖ Raffles Module: –ú–æ–¥—É–ª—ñ —É—Å–ø—ñ—à–Ω–æ –∑–Ω–∏—â–µ–Ω–æ");

        return this;
    }
}

// –°—Ç–≤–æ—Ä—é—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –º–æ–¥—É–ª—è
const rafflesModule = new RafflesModule();

// –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ –º–æ–¥—É–ª—å
export default rafflesModule;

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        rafflesModule.init();
    });
} else {
    // –£ –≤–∏–ø–∞–¥–∫—É, —è–∫—â–æ DOM –≤–∂–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
    setTimeout(() => {
        rafflesModule.init();
    }, 100);
}